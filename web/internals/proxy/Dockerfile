FROM nginx

ARG SERVER_NAME
ARG WEBAPP_PORT
ARG ELASTICSEARCH_PROXY_PREFIX
ARG ELASTICSEARCH_PROXY_HOST
ARG ELASTICSEARCH_PROXY_PORT

ENV ELASTICSEARCH_PROXY_HOST ${ELASTICSEARCH_PROXY_HOST:-localhost}
ENV ELASTICSEARCH_PROXY_PORT ${ELASTICSEARCH_PROXY_PORT:-9200}
ENV ELASTICSEARCH_PROXY_PREFIX ${ELASTICSEARCH_PROXY_PREFIX:-/api/search}
ENV SERVER_NAME $SERVER_NAME
ENV WEBAPP_PORT $WEBAPP_PORT
ENV NGINX_CERT_DIR=/etc/nginx/cert

RUN apt-get update; apt-get install -y \
    openssl

ADD nginx.conf.template /etc/nginx/nginx.conf.template
USER root
RUN envsubst '$WEBAPP_PORT $SERVER_NAME $ELASTICSEARCH_PROXY_HOST $ELASTICSEARCH_PROXY_PORT $ELASTICSEARCH_PROXY_PREFIX' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf

WORKDIR $NGINX_CERT_DIR

RUN mkdir -p $NGINX_CERT_DIR/certs/ && chown root:root $NGINX_CERT_DIR/certs/
ADD gen_key.sh $NGINX_CERT_DIR/gen_key.sh
RUN chmod a+x $NGINX_CERT_DIR/gen_key.sh
RUN bash -c "$NGINX_CERT_DIR/gen_key.sh $SERVER_NAME"
#RUN ls $NGINX_CERT_DIR
